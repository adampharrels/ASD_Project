<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Room Booking - UniSpace</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="styles-home.css">
    <style>
        .booking-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            background: var(--bg);
            min-height: 100vh;
        }
        
        .booking-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }
        
        .booking-header h1 {
            color: var(--brand);
            margin: 0;
            font-size: 2rem;
        }
        
        .nav-links {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .nav-links a {
            color: var(--muted);
            text-decoration: none;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        
        .nav-links a:hover {
            background: var(--panel);
            color: var(--ink);
        }
        
        .booking-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }
        
        @media (max-width: 768px) {
            .booking-grid {
                grid-template-columns: 1fr;
            }
            .booking-container {
                padding: 1rem;
            }
        }
        
        .section-card {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
        }
        
        .section-card h2 {
            color: var(--brand);
            margin-top: 0;
            margin-bottom: 1rem;
            font-size: 1.25rem;
        }
    </style>
</head>
<body>
 <!-- Header / Top Nav - Same as home.html -->
 <header class="site-header container">
   <nav class="nav">
     <a class="brand" href="home.html">UniSpace</a>
     <ul class="nav-links">
       <li><a class="nav-button active" href="booking.html">Reserve</a></li>
       <li><a class="nav-button" href="#">Calendar</a></li>
     </ul>
     <div class="nav-spacer"></div>
     <div class="profile-menu-wrapper">
       <button id="profileBtn" class="profile-btn" aria-label="Profile" aria-haspopup="true" aria-expanded="false">
         <img src="assets/icons/user.svg" alt="Profile" />
       </button>
       <nav id="profileDropdown" class="profile-dropdown hidden" role="menu">
         <ul>
           <li><a role="menuitem" href="profile.html" tabindex="0">Profile</a></li>
           <li><a role="menuitem" href="settings.html" tabindex="0">Settings</a></li>
           <li><a role="menuitem" href="#" tabindex="0" style="color:#d32f2f">Log out</a></li>
         </ul>
       </nav>
     </div>
   </nav>
 </header>

    <div class="booking-container">
        <div class="booking-header">
            <h1>üè¢ Room Booking</h1>
            <div class="nav-links">
                <a href="home.html">üè† Home</a>
                <a href="calendar.html">üìÖ Calendar</a>
                <a href="profile.html">üë§ Profile</a>
            </div>
        </div>

        <div class="booking-grid">
            <div class="section-card" id="room-selection">
                <h2> Book a New Room</h2>
                <form id="booking-form" method="POST" action="/book-room">
                    <label for="room">Room:</label>
                    <select id="room" name="room">
                        <option value="">Select a room...</option>
                        <option value="CB06.06.112">CB06.06.112 - Group Study Room (8 people)</option>
                        <option value="CB06.06.113">CB06.06.113 - Group Study Room (8 people)</option>
                        <option value="CB07.02.010A">CB07.02.010A - Online Learning Room (2 people)</option>
                        <option value="CB07.02.010B">CB07.02.010B - Online Learning Room (2 people)</option>
                        <option value="CB06.03.205">CB06.03.205 - Group Study Room (12 people)</option>
                        <option value="CB06.03.206">CB06.03.206 - Group Study Room (10 people)</option>
                        <option value="CB08.01.115">CB08.01.115 - Lecture Room (50 people)</option>
                        <option value="CB08.01.116">CB08.01.116 - Lecture Room (40 people)</option>
                        <option value="CB09.02.301">CB09.02.301 - Conference Room (16 people)</option>
                        <option value="CB09.02.302">CB09.02.302 - Conference Room (20 people)</option>
                    </select>

                    <label for="date">Date:</label>
                    <input type="date" id="date" name="date" required>

                    <label for="time">Start Time:</label>
                    <input type="time" id="time" name="time" required>

                    <label for="duration">Duration (minutes):</label>
                    <select id="duration" name="duration" required>
                        <option value="">Select duration...</option>
                        <option value="30">30 minutes</option>
                        <option value="60">1 hour</option>
                        <option value="90">1.5 hours</option>
                        <option value="120">2 hours</option>
                        <option value="180">3 hours</option>
                        <option value="240">4 hours</option>
                    </select>

                    <button type="submit"> Book Room </button>
                </form>
            </div>

            <div class="section-card" id="my-bookings">
                <h2>üìã My Current Bookings</h2>
                <div id="loading-bookings" style="color: var(--muted); font-style: italic; text-align: center; padding: 1rem;">
                    üîÑ Loading your bookings...
                </div>
                <ul id="booking-list" style="display: none;">
                    <!-- Bookings will be loaded here -->
                </ul>
                <div id="no-bookings" style="color: var(--muted); font-style: italic; text-align: center; padding: 1rem; display: none;">
                    üìã No active bookings found. Create your first booking!
                </div>
            </div>
        </div>
    </div>

    <script defer>
        // Set minimum date to today
        document.getElementById('date').min = new Date().toISOString().split('T')[0];
        
        // Load user's current bookings when page loads
        async function loadMyBookings() {
            try {
                const response = await fetch('/api/user-bookings?status=current');
                if (!response.ok) {
                    throw new Error('Failed to load bookings');
                }
                
                const bookings = await response.json();
                displayBookings(bookings);
            } catch (error) {
                console.error('Error loading bookings:', error);
                document.getElementById('loading-bookings').style.display = 'none';
                document.getElementById('no-bookings').innerHTML = '‚ùå Error loading bookings. Please refresh.';
                document.getElementById('no-bookings').style.display = 'block';
            }
        }
        
        function displayBookings(bookings) {
            const loadingElement = document.getElementById('loading-bookings');
            const bookingList = document.getElementById('booking-list');
            const noBookingsElement = document.getElementById('no-bookings');
            
            loadingElement.style.display = 'none';
            
            if (bookings.length === 0) {
                noBookingsElement.style.display = 'block';
                bookingList.style.display = 'none';
                return;
            }
            
            bookingList.innerHTML = '';
            bookingList.style.display = 'block';
            noBookingsElement.style.display = 'none';
            
            bookings.forEach(booking => {
                const listItem = document.createElement('li');
                const startDate = new Date(booking.startTime);
                const endDate = new Date(booking.endTime);
                
                // Calculate duration
                const durationMs = endDate - startDate;
                const durationMinutes = Math.round(durationMs / (1000 * 60));
                
                listItem.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start; padding: 0.5rem 0; border-bottom: 1px solid var(--border);">
                        <div>
                            <strong style="color: var(--brand);">üè¢ ${booking.roomName}</strong><br>
                            <small style="color: var(--ink);">üìÖ ${startDate.toLocaleDateString()} at ${startDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</small><br>
                            <small style="color: var(--muted);">‚è±Ô∏è Duration: ${durationMinutes} minutes</small><br>
                            <small style="color: var(--muted);">üé´ <strong>${booking.bookingRef || 'REF-' + booking.timeID}</strong></small><br>
                            <small style="color: var(--muted);">üìç ${booking.roomType} ‚Ä¢ ${booking.capacity} people</small>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                            <span style="background: #10b981; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; text-align: center;">
                                ${booking.bookingStatus}
                            </span>
                            <button onclick="cancelBooking(${booking.timeID}, this)" 
                                    style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 11px;"
                                    title="Cancel booking">
                                ‚ùå Cancel
                            </button>
                        </div>
                    </div>
                `;
                bookingList.appendChild(listItem);
            });
        }
        
        // Cancel booking function
        async function cancelBooking(bookingId, buttonElement) {
            if (!confirm('Are you sure you want to cancel this booking?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/user-bookings?bookingId=${bookingId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    // Remove the booking from the UI
                    buttonElement.closest('li').remove();
                    
                    // Check if no bookings left
                    const bookingList = document.getElementById('booking-list');
                    if (bookingList.children.length === 0) {
                        bookingList.style.display = 'none';
                        document.getElementById('no-bookings').style.display = 'block';
                    }
                    
                    alert('‚úÖ Booking cancelled successfully!');
                } else {
                    const error = await response.json();
                    alert('‚ùå Failed to cancel booking: ' + (error.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error cancelling booking:', error);
                alert('‚ùå Error cancelling booking. Please try again.');
            }
        }
        
        // Make cancelBooking globally available
        window.cancelBooking = cancelBooking;

        // Form submission handler - Make real API call
        document.getElementById('booking-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const room = formData.get('room');
            const date = formData.get('date');
            const time = formData.get('time');
            const duration = formData.get('duration');
            
            if (!room || !date || !time || !duration) {
                alert('Please fill in all fields');
                return;
            }
            
            // Disable submit button during request
            const submitButton = this.querySelector('button[type="submit"]');
            const originalText = submitButton.textContent;
            submitButton.disabled = true;
            submitButton.textContent = 'üîÑ Booking...';
            
            try {
                // Convert FormData to URLSearchParams for proper servlet handling
                const urlParams = new URLSearchParams();
                urlParams.append('room', room);
                urlParams.append('date', date);
                urlParams.append('time', time);
                urlParams.append('duration', duration);
                
                const response = await fetch('/book-room', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: urlParams
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    // Show success message with memorable booking reference
                    alert(`‚úÖ ${result.message}\nüé´ Booking Reference: ${result.bookingRef}\nüìù ${result.bookingRefDisplay || ''}`);
                    
                    // Reset form
                    this.reset();
                    
                    // Reload bookings to show the new one
                    await loadMyBookings();
                } else {
                    alert('‚ùå ' + (result.error || 'Failed to book room'));
                }
            } catch (error) {
                console.error('Error booking room:', error);
                alert('‚ùå Error booking room. Please try again.');
            } finally {
                // Re-enable submit button
                submitButton.disabled = false;
                submitButton.textContent = originalText;
            }
        });
        
        // Load bookings when page loads
        document.addEventListener('DOMContentLoaded', loadMyBookings);
    </script>
    
    <!-- Profile Dropdown JS - Same as home.html -->
    <script src="js/home.js"></script>
</body>
</html>
