<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Room Booking - UniSpace</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="styles-home.css">
    <link rel="stylesheet" href="booking.css">
    <style>
        .booking-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            background: var(--bg);
            min-height: 100vh;
        }
        
        .booking-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }
        
        .booking-header h1 {
            color: var(--brand);
            margin: 0;
            font-size: 2rem;
        }
        
        /* Removed conflicting .nav-links styles that were affecting the header navigation */
        
        .booking-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }
        
        @media (max-width: 768px) {
            .booking-grid {
                grid-template-columns: 1fr;
            }
            .booking-container {
                padding: 1rem;
            }
        }
        
        .section-card {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
        }
        
        .section-card h2 {
            color: var(--brand);
            margin-top: 0;
            margin-bottom: 1rem;
            font-size: 1.25rem;
        }
    </style>
</head>

<script>
    async function loadBookingsHistory() {
        const tbody = document.querySelector("#history-table tbody");
        if (!tbody) return;
        tbody.innnerHTML = '<tr><td colspan="6">Loading...</td></tr>';
        try {
            const res = await fetch(new URL('/book-room', window.location.origin));
            if (!res.ok) throw new Error('Fetch failed: ' + res.status);
            const entries = await res.json();
            if (!Array.isArray(entries) || entries.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6">No past bookings found.</td></tr>';
                return;
            }
            tbody.innerHTML = '';
            entries.forEach(b => {
                const start = b.startTime ? new Date(b.startTime) : null;
                const end = b.endTime ? new Date(b.endTime) : null;
                const date = start ? start.toLocaleDateString() : '';
                const time = start && end ? `${start.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} - ${end.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}` : '';
                const duration = (start && end) ? Math.round((end - start)/60000) + ' min' : '';
                const ref = b.bookingRef || b.bookingID || '';
                const status = b.bookingStatus || '';
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${b.roomName || b.roomId || ''}</td>
                    <td>${date}</td>
                    <td>${time}</td>
                    <td>${duration}</td>
                    <td><strong>${ref}</strong></td>
                    <td>${status}</td>
                `;
                tbody.appendChild(row);
            });
        } catch (error) {
            tbody.innerHTML = '<tr><td colspan="6"> style="text-align:center;color:#c00">Error loading booking history</td></tr>';
            console.error(err);
        }
    }
    document.addEventListener('DOMContentLoaded', () => {
        loadBookingsHistory();
    });
</script>

<body>
 <!-- Header / Top Nav - Same as home.html -->
 <header class="site-header container">
   <nav class="nav">
     <a class="brand" href="home.html">UniSpace</a>
     <ul class="nav-links">
       <li><a class="nav-button active" href="booking.html">My Bookings</a></li>
       <li><a class="nav-button" href="calendar.html">Calendar</a></li>
     </ul>
     <div class="nav-spacer"></div>
     <div class="profile-menu-wrapper">
       <button id="profileBtn" class="profile-btn" aria-label="Profile" aria-haspopup="true" aria-expanded="false">
         <img src="assets/icons/user.svg" alt="Profile" />
       </button>
       <nav id="profileDropdown" class="profile-dropdown hidden" role="menu">
         <ul>
           <li><a role="menuitem" href="profile.html" tabindex="0">Profile</a></li>
           <li><a role="menuitem" href="settings.html" tabindex="0">Settings</a></li>
           <li><a role="menuitem" href="#" tabindex="0" style="color:#d32f2f">Log out</a></li>
         </ul>
       </nav>
     </div>
   </nav>
 </header>

    <div class="booking-container">
        <div class="booking-grid">
            
                   
            
                <section id="my-bookings" class="section-card">
                    <div class="section-card">
                        <h2>📋 My Current Bookings</h2>
                        <div id="loading-bookings" style="color: var(--muted); font-style: italic; text-align: center; padding: 1rem;">
                            🔄 Loading your bookings...
                        </div>
                        <ul id="booking-list" style="display: none;">
                            <!-- Bookings will be loaded here -->
                        </ul>
                        <div id="no-bookings" style="color: var(--muted); font-style: italic; text-align: center; padding: 1rem; display: none;">
                            📋 No active bookings found. Create your first booking!
                        </div>
                    </div>
                </section>

            
                <section id="booking-history" class="section-card">
                        <h2> Booking History </h2>
                            <div style="overflow:auto">
                                <table id="history-table" class="history-table" aria-describedby="history=caption">
                                    <thead>
                                        <tr>
                                            <th>Room</th>
                                            <th>Date</th>
                                            <th>Time</th>
                                            <th>Duration</th>
                                            <th>Booking Ref</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- history rows -->
                                    </tbody>
                                </table>
                            </div>
                            <div id="no-history" style="color: var(--muted); font-style: italic; text-align: center; padding: 1rem; display: none;">
                                No past bookings found.
                            </div>
                </section>
            </div>
        </div>
    </div>

    <script defer>
        async function loadBookings() {
            try {
                const response = await fetch('/api/user-bookings?status=past');
                if (!response.ok) {
                    throw new Error('Failed to load booking history');
                }
                
                const bookings = await response.json();
                displayBookingHistory(bookings);
            } catch (error) {
                console.error('Error loading booking history:', error);
                document.getElementById('no-history').innerHTML = 'Error loading booking history. Please refresh.';
                document.getElementById('no-history').style.display = 'block';
            }
        }

        function displayHistory(entries) {
            const table = document.querySelector("#history-table tbody");
            const noHistory = document.getElementbyId("no-history");
            table.innerHTM = '';
            if (!entries || entries.length === 0) {
                noHistory.style.display = 'block';
                return;
            }
            noHistory.style.display = 'none';
            entries.forEach(b => {
                const start = new Date(b.startTime);
                const end = new Date(b.endTime);
                const durationMin = Math.round((end - start) / 60000);
                const tr = document.createElement('tr');
                tr.innerHTM = `
                    <td>${b.roomName}</td>
                    <td>${start.toLocaleDateString()}</td>
                    <td>${start.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</td>
                    <td>${durationMin} minutes</td>
                    <td><strong>${b.bookingRef || 'REF-' + b.timeID}</strong></td>
                    <td>${b.bookingStatus}</td>
                `;
                table.appendChild(tr);
            });
        }
        document.addEventListener('DOMContentLoaded', () => {
            loadBookings();
            //loadBookingsHistory();
        });

    </script>

    <script>
        // Load current bookings and history; robust to network errors and avoids runtime typos
        async function fetchJson(url) {
            const res = await fetch(url, { credentials: 'same-origin' });
            if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
            return res.json();
        }

        async function loadMyBookings() {
            try {
                const bookings = await fetchJson('/api/user-bookings?status=current');
                displayBookings(bookings || []);
            } catch (err) {
                console.error('Error loading bookings:', err);
                document.getElementById('loading-bookings').style.display = 'none';
                const noEl = document.getElementById('no-bookings');
                noEl.textContent = '❌ Error loading bookings. Please refresh.';
                noEl.style.display = 'block';
            }
        }
        
        function displayBookings(bookings) {
            const loadingElement = document.getElementById('loading-bookings');
            const bookingList = document.getElementById('booking-list');
            const noBookingsElement = document.getElementById('no-bookings');
            loadingElement.style.display = 'none';
            if (!Array.isArray(bookings) || bookings.length === 0) {
                noBookingsElement.style.display = 'block';
                bookingList.style.display = 'none';
                return;
            }
            bookingList.innerHTML = '';
            bookingList.style.display = 'block';
            noBookingsElement.style.display = 'none';
            bookings.forEach(booking => {
                const start = new Date(booking.startTime);
                const end = new Date(booking.endTime);
                const minutes = Math.round((end - start) / 60000);
                const li = document.createElement('li');
                li.innerHTML = `
                    <div style="display:flex;justify-content:space-between;align-items:start;padding:0.5rem 0;border-bottom:1px solid var(--border);">
                    <div>
                        <strong>🏢 ${booking.roomName || booking.roomId}</strong><br>
                        <small>📅 ${start.toLocaleDateString()} • ${start.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</small><br>
                        <small>⏱ ${minutes} min • ${booking.capacity || ''}p</small><br>
                        <small>🎫 <strong>${booking.bookingRef || ('REF-' + (booking.timeID || booking.bookingID || ''))}</strong></small>
                    </div>
                    <div style="display:flex;flex-direction:column;gap:0.25rem;">
                        <span style="background:#10b981;color:#fff;padding:2px 6px;border-radius:4px;font-size:10px;">${booking.bookingStatus || 'Active'}</span>
                    </div>
                    </div>`;
                bookingList.appendChild(li);
                });
            }

            async function loadBookingHistory() {
                try {
                const history = await fetchJson('/api/user-bookings?status=past');
                displayHistory(history || []);
                } catch (err) {
                console.error('Error loading booking history:', err);
                const noHistory = document.getElementById('no-history');
                if (noHistory) {
                    noHistory.textContent = 'Error loading booking history. Please refresh.';
                    noHistory.style.display = 'block';
                }
                }
            }

            function displayHistory(entries) {
                const tbody = document.querySelector('#history-table tbody');
                const noHistory = document.getElementById('no-history');
                if (!tbody) return;
                tbody.innerHTML = '';
                if (!Array.isArray(entries) || entries.length === 0) {
                if (noHistory) noHistory.style.display = 'block';
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#666">No history</td></tr>';
                return;
                }
                if (noHistory) noHistory.style.display = 'none';
                entries.forEach(b => {
                const start = b.startTime ? new Date(b.startTime) : null;
                const end = b.endTime ? new Date(b.endTime) : null;
                const date = start ? start.toLocaleDateString() : '';
                const time = start && end ? `${start.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}–${end.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}` : '';
                const duration = (start && end) ? Math.round((end - start)/60000) + ' min' : '';
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${b.roomName || b.roomId || ''}</td>
                    <td>${date}</td>
                    <td>${time}</td>
                    <td>${duration}</td>
                    <td>${b.bookingRef || b.bookingID || ''}</td>
                    <td>${b.bookingStatus || ''}</td>
                `;
                tbody.appendChild(tr);
                });
            }

            document.addEventListener('DOMContentLoaded', () => {
            loadMyBookings();
            loadBookingHistory();
        });
        </script>
        <script>
            async function cancelBooking(bookingId, buttonElement) {
                if (!confirm('Are you sure you want to cancel this booking?')) {
                    return;
                }
                
                try {
                    const response = await fetch(`/api/user-bookings?bookingId=${bookingId}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        // Remove the booking from the UI
                        buttonElement.closest('li').remove();
                        
                        // Check if no bookings left
                        const bookingList = document.getElementById('booking-list');
                        if (bookingList.children.length === 0) {
                            bookingList.style.display = 'none';
                            document.getElementById('no-bookings').style.display = 'block';
                        }
                        
                        alert('✅ Booking cancelled successfully!');
                    } else {
                        const error = await response.json();
                        alert('❌ Failed to cancel booking: ' + (error.error || 'Unknown error'));
                    }
                } catch (error) {
                    console.error('Error cancelling booking:', error);
                    alert('❌ Error cancelling booking. Please try again.');
                }
            }
            
            // Make cancelBooking globally available
            window.cancelBooking = cancelBooking;

            // Form submission handler - Make real API call
            document.getElementById('booking-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const room = formData.get('room');
                const date = formData.get('date');
                const time = formData.get('time');
                const duration = formData.get('duration');
                
                if (!room || !date || !time || !duration) {
                    alert('Please fill in all fields');
                    return;
                }
                
                // Disable submit button during request
                const submitButton = this.querySelector('button[type="submit"]');
                const originalText = submitButton.textContent;
                submitButton.disabled = true;
                submitButton.textContent = '🔄 Booking...';
                
                try {
                    // Convert FormData to URLSearchParams for proper servlet handling
                    const urlParams = new URLSearchParams();
                    urlParams.append('room', room);
                    urlParams.append('date', date);
                    urlParams.append('time', time);
                    urlParams.append('duration', duration);
                    
                    const response = await fetch('/book-room', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: urlParams
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok && result.success) {
                        // Show success message with memorable booking reference
                        alert(`✅ ${result.message}\n🎫 Booking Reference: ${result.bookingRef}\n📝 ${result.bookingRefDisplay || ''}`);
                        
                        // Reset form
                        this.reset();
                        
                        // Reload bookings to show the new one
                        await loadMyBookings();
                    } else {
                        alert('❌ ' + (result.error || 'Failed to book room'));
                    }
                } catch (error) {
                    console.error('Error booking room:', error);
                    alert('❌ Error booking room. Please try again.');
                } finally {
                    // Re-enable submit button
                    submitButton.disabled = false;
                    submitButton.textContent = originalText;
                }
            });
            
            // Load bookings when page loads
            document.addEventListener('DOMContentLoaded', loadMyBookings);
    </script>
    
    <!-- Profile Dropdown JS - Same as home.html -->
    <script src="js/home.js"></script>
</body>
</html>
