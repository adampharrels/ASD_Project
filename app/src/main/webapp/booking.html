<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Room Booking - UniSpace</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="styles-home.css">
    <link rel="stylesheet" href="booking.css">
    <style>
        .booking-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            background: var(--bg);
            min-height: 100vh;
        }
        
        .booking-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }
        
        .booking-header h1 {
            color: var(--brand);
            margin: 0;
            font-size: 2rem;
        }
        
        .booking-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }
        
        @media (max-width: 768px) {
            .booking-grid {
                grid-template-columns: 1fr;
            }
            .booking-container {
                padding: 1rem;
            }
        }
        
        .section-card {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
        }
        
        .section-card h2 {
            color: var(--brand);
            margin-top: 0;
            margin-bottom: 1rem;
            font-size: 1.25rem;
        }
        .hidden { display:none !important; }
        .btn-rate { padding:6px 10px;border-radius:6px;border:1px solid #2563eb;background:#fff;color:#2563eb;cursor:pointer; }
        .btn-rate:hover { background:#f0f7ff; }
    </style>
</head>

<script>
    async function loadBookingsHistory() {
        const tbody = document.querySelector("#history-table tbody");
        if (!tbody) return;
        tbody.innnerHTML = '<tr><td colspan="6">Loading...</td></tr>';
        try {
            const res = await fetch(new URL('/book-room', window.location.origin));
            if (!res.ok) throw new Error('Fetch failed: ' + res.status);
            const entries = await res.json();
            if (!Array.isArray(entries) || entries.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6">No past bookings found.</td></tr>';
                return;
            }
            tbody.innerHTML = '';
            entries.forEach(b => {
                const start = b.startTime ? new Date(b.startTime) : null;
                const end = b.endTime ? new Date(b.endTime) : null;
                const date = start ? start.toLocaleDateString() : '';
                const time = start && end ? `${start.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} - ${end.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}` : '';
                const duration = (start && end) ? Math.round((end - start)/60000) + ' min' : '';
                const ref = b.bookingRef || b.bookingID || '';
                const status = b.bookingStatus || '';
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${b.roomName || b.roomId || ''}</td>
                    <td>${date}</td>
                    <td>${time}</td>
                    <td>${duration}</td>
                    <td><strong>${ref}</strong></td>
                    <td>${status}</td>
                `;
                tbody.appendChild(row);
            });
        } catch (error) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#c00">Error loading booking history</td></tr>';
            console.error(error);
        }
    }
    document.addEventListener('DOMContentLoaded', () => {
        loadBookingsHistory();
    });
</script>

<script>
  function openRatingsPanel() {
    const modal = document.getElementById('rating-modal');
    if (modal) {
      modal.classList.remove('hidden');
      modal.dataset.bookingId = ''; 
    } else {
      const el = document.getElementById('booking-history') || document.querySelector('#history-table');
      if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    if (window.location.hash === '#ratings') {
      openRatingsPanel();
      history.replaceState(null, '', window.location.pathname + window.location.search);
    }
    window.openRatingsPanel = openRatingsPanel;
  });
</script>

<body>
 <header class="site-header container">
   <nav class="nav">
     <a class="brand" href="home.html">UniSpace</a>
     <ul class="nav-links">
       <li><a class="nav-button active" href="booking.html">My Bookings</a></li>
       <li><a class="nav-button" href="calendar.html">Calendar</a></li>
     </ul>
     <div class="nav-spacer"></div>
     <div class="profile-menu-wrapper">
       <button id="profileBtn" class="profile-btn" aria-label="Profile" aria-haspopup="true" aria-expanded="false">
         <img src="assets/icons/user.svg" alt="Profile" />
       </button>
       <nav id="profileDropdown" class="profile-dropdown hidden" role="menu">
         <ul>
           <li><a role="menuitem" href="profile.html" tabindex="0">Profile</a></li>
           <li><a role="menuitem" href="settings.html" tabindex="0">Settings</a></li>
           <li><a role="menuitem" href="#" tabindex="0" style="color:#d32f2f">Log out</a></li>
         </ul>
       </nav>
     </div>
   </nav>
 </header>

    <div class="booking-container">
        <div class="booking-grid">
            
                   
            
                <section id="my-bookings" class="section-card">
                    <div class="section-card">
                        <h2>üìã My Current Bookings</h2>
                        <div id="loading-bookings" style="color: var(--muted); font-style: italic; text-align: center; padding: 1rem;">
                            üîÑ Loading your bookings...
                        </div>
                        <ul id="booking-list" style="display: none;">
                        </ul>
                        <div id="no-bookings" style="color: var(--muted); font-style: italic; text-align: center; padding: 1rem; display: none;">
                            üìã No active bookings found. Create your first booking!
                        </div>
                    </div>
                </section>

            
                <section id="booking-history" class="section-card">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
                            <h2 style="margin:0;">üìö Booking History</h2>
                            <button onclick="clearAllRatings()" style="padding:6px 12px;background:#dc3545;color:white;border:none;border-radius:6px;cursor:pointer;font-size:13px;">Clear All Ratings</button>
                        </div>
                            <div style="overflow:auto">
                                <table id="history-table" class="history-table" aria-describedby="history=caption">
                                    <thead>
                                        <tr>
                                            <th>Room</th>
                                            <th>Date</th>
                                            <th>Time</th>
                                            <th>Duration</th>
                                            <th>Booking Ref</th>
                                            <th>Status</th>
                                            <th>Rate</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    </tbody>
                                </table>
                            </div>
                            <div id="no-history" style="color: var(--muted); font-style: italic; text-align: center; padding: 1rem; display: none;">
                                No past bookings found.
                            </div>
                </section>
            </div>
        </div>
    </div>

    <script defer>
        async function loadBookings() {
            try {
                const response = await fetch('/api/user-bookings?status=past');
                if (!response.ok) {
                    throw new Error('Failed to load booking history');
                }
                
                const bookings = await response.json();
                displayHistory(bookings);
            } catch (error) {
                console.error('Error loading booking history:', error);
                document.getElementById('no-history').innerHTML = 'Error loading booking history. Please refresh.';
                document.getElementById('no-history').style.display = 'block';
            }
        }

        function displayHistory(entries) {
            const table = document.querySelector("#history-table tbody");
            const noHistory = document.getElementbyId("no-history");
            table.innerHTM = '';
            if (!entries || entries.length === 0) {
                noHistory.style.display = 'block';
                return;
            }
            noHistory.style.display = 'none';
            entries.forEach(b => {
                const start = new Date(b.startTime);
                const end = new Date(b.endTime);
                const durationMin = Math.round((end - start) / 60000);
                const tr = document.createElement('tr');
                tr.innerHTM = `
                    <td>${b.roomName}</td>
                    <td>${start.toLocaleDateString()}</td>
                    <td>${start.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</td>
                    <td>${durationMin} minutes</td>
                    <td><strong>${b.bookingRef || 'REF-' + b.timeID}</strong></td>
                    <td>${b.bookingStatus}</td>
                `;
                table.appendChild(tr);
            });
        }
        document.addEventListener('DOMContentLoaded', () => {
            loadBookings();
        });

    </script>

    <script>
        async function fetchJson(url) {
            const res = await fetch(url, { credentials: 'same-origin' });
            if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
            return res.json();
        }

        async function loadMyBookings() {
            try {
                const bookings = await fetchJson('/api/user-bookings?status=current');
                displayBookings(bookings || []);
            } catch (err) {
                console.error('Error loading bookings:', err);
                document.getElementById('loading-bookings').style.display = 'none';
                const noEl = document.getElementById('no-bookings');
                noEl.textContent = '‚ùå Error loading bookings. Please refresh.';
                noEl.style.display = 'block';
            }
        }
        
        function displayBookings(bookings) {
            const loadingElement = document.getElementById('loading-bookings');
            const bookingList = document.getElementById('booking-list');
            const noBookingsElement = document.getElementById('no-bookings');
            loadingElement.style.display = 'none';
            if (!Array.isArray(bookings) || bookings.length === 0) {
                noBookingsElement.style.display = 'block';
                bookingList.style.display = 'none';
                return;
            }
            bookingList.innerHTML = '';
            bookingList.style.display = 'block';
            noBookingsElement.style.display = 'none';
            bookings.forEach(booking => {
                const start = new Date(booking.startTime);
                const end = new Date(booking.endTime);
                const minutes = Math.round((end - start) / 60000);
                const li = document.createElement('li');
                li.innerHTML = `
                    <div style="display:flex;justify-content:space-between;align-items:start;padding:0.5rem 0;border-bottom:1px solid var(--border);">
                    <div>
                        <strong>üè¢ ${booking.roomName || booking.roomId}</strong><br>
                        <small>üìÖ ${start.toLocaleDateString()} ‚Ä¢ ${start.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</small><br>
                        <small>‚è± ${minutes} min ‚Ä¢ ${booking.capacity || ''}p</small><br>
                        <small>üé´ <strong>${booking.bookingRef || ('REF-' + (booking.timeID || booking.bookingID || ''))}</strong></small>
                    </div>
                    <div style="display:flex;flex-direction:column;gap:0.25rem;">
                        <span style="background:#10b981;color:#fff;padding:2px 6px;border-radius:4px;font-size:10px;">${booking.bookingStatus || 'Active'}</span>
                    </div>
                    </div>`;
                bookingList.appendChild(li);
                });
            }

        </script>
        <script>
            async function loadBookingHistory() {
                try {
                const history = await fetchJson('/api/user-bookings?status=past');
                displayHistory(history || []);
                } catch (err) {
                console.error('Error loading booking history:', err);
                const noHistory = document.getElementById('no-history');
                if (noHistory) {
                    noHistory.textContent = 'Error loading booking history. Please refresh.';
                    noHistory.style.display = 'block';
                }
                }
            }

            function displayHistory(entries) {
                const tbody = document.querySelector('#history-table tbody');
                const noHistory = document.getElementById('no-history');
                if (!tbody) return;
                tbody.innerHTML = '';
                if (!Array.isArray(entries) || entries.length === 0) {
                if (noHistory) noHistory.style.display = 'block';
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#666">No history</td></tr>';
                return;
                }
                if (noHistory) noHistory.style.display = 'none';
                entries.forEach(b => {
                console.log('üìä Booking data:', b); // Debug log
                const start = b.startTime ? new Date(b.startTime) : null;
                const end = b.endTime ? new Date(b.endTime) : null;
                const date = start ? start.toLocaleDateString() : '';
                const time = start && end ? `${start.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}‚Äì${end.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}` : '';
                const duration = (start && end) ? Math.round((end - start)/60000) + ' min' : '';
                const tr = document.createElement('tr');

                // Room
                    const tdRoom = document.createElement('td');
                    tdRoom.textContent = b.roomName || b.roomId || '';
                    tr.appendChild(tdRoom);

                    // Date
                    const tdDate = document.createElement('td');
                    tdDate.textContent = date;
                    tr.appendChild(tdDate);

                    // Time
                    const tdTime = document.createElement('td');
                    tdTime.textContent = time;
                    tr.appendChild(tdTime);

                    // Duration
                    const tdDuration = document.createElement('td');
                    tdDuration.textContent = duration;
                    tr.appendChild(tdDuration);

                    // Booking Ref
                    const tdRef = document.createElement('td');
                    tdRef.innerHTML = `<strong>${b.bookingRef || b.bookingID || ''}</strong>`;
                    tr.appendChild(tdRef);

                    // Status
                    const tdStatus = document.createElement('td');
                    tdStatus.textContent = b.bookingStatus || '';
                    tr.appendChild(tdStatus);

                    // Rate button column
                    const tdRate = document.createElement('td');
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'btn-rate';
                    btn.textContent = 'Rate';
                    const bookingId = b.bookingID || b.timeID || b.id || '';
                    const roomLabel = b.roomName || b.roomId || '';
                    console.log('üéØ Rate button - bookingId:', bookingId, 'from booking:', b.bookingID, b.timeID, b.id);
                    btn.addEventListener('click', () => {
                        if (typeof openRatingModal === 'function') {
                            openRatingModal(bookingId, roomLabel);
                        } else {
                            openRatingsPanel?.();
                        }
                    });
                    tdRate.appendChild(btn);
                    tr.appendChild(tdRate);
                tbody.appendChild(tr);
                });
            }

            document.addEventListener('DOMContentLoaded', () => {
            loadMyBookings();
            loadBookingHistory();
        });
        </script>
        <script>
            async function cancelBooking(bookingId, buttonElement) {
                if (!confirm('Are you sure you want to cancel this booking?')) {
                    return;
                }
                
                try {
                    const response = await fetch(`/api/user-bookings?bookingId=${bookingId}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        buttonElement.closest('li').remove();
                        const bookingList = document.getElementById('booking-list');
                        if (bookingList.children.length === 0) {
                            bookingList.style.display = 'none';
                            document.getElementById('no-bookings').style.display = 'block';
                        }
                        
                        alert('‚úÖ Booking cancelled successfully!');
                    } else {
                        const error = await response.json();
                        alert('‚ùå Failed to cancel booking: ' + (error.error || 'Unknown error'));
                    }
                } catch (error) {
                    console.error('Error cancelling booking:', error);
                    alert('‚ùå Error cancelling booking. Please try again.');
                }
            }
            window.cancelBooking = cancelBooking;

            const bookingForm = document.getElementById('booking-form');
            if (bookingForm) {
                bookingForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const room = formData.get('room');
                const date = formData.get('date');
                const time = formData.get('time');
                const duration = formData.get('duration');
                
                if (!room || !date || !time || !duration) {
                    alert('Please fill in all fields');
                    return;
                }
                
                const submitButton = this.querySelector('button[type="submit"]');
                const originalText = submitButton.textContent;
                submitButton.disabled = true;
                submitButton.textContent = 'üîÑ Booking...';
                
                try {
                    const urlParams = new URLSearchParams();
                    urlParams.append('room', room);
                    urlParams.append('date', date);
                    urlParams.append('time', time);
                    urlParams.append('duration', duration);
                    
                    const response = await fetch('/book-room', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: urlParams
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok && result.success) {
                        // Show success message with memorable booking reference
                        alert(`‚úÖ ${result.message}\nüé´ Booking Reference: ${result.bookingRef}\nüìù ${result.bookingRefDisplay || ''}`);
                        
                        // Reset form
                        this.reset();
                        
                        // Reload bookings to show the new one
                        await loadMyBookings();
                    } else {
                        alert('‚ùå ' + (result.error || 'Failed to book room'));
                    }
                } catch (error) {
                    console.error('Error booking room:', error);
                    alert('‚ùå Error booking room. Please try again.');
                } finally {
                    // Re-enable submit button
                    submitButton.disabled = false;
                    submitButton.textContent = originalText;
                }
            });
            }
            
            // Load bookings when page loads
            document.addEventListener('DOMContentLoaded', loadMyBookings);
    </script>
    
    
<div id="rating-modal" class="hidden" aria-hidden="true" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:1200;">
  <div style="background:rgba(0,0,0,0.45);position:absolute;inset:0;" onclick="closeRatingModal()"></div>
  <div role="dialog" aria-modal="true" style="position:relative;background:#fff;border-radius:8px;padding:1rem;max-width:520px;width:100%;box-shadow:0 10px 30px rgba(0,0,0,0.2);">
    <button type="button" onclick="closeRatingModal()" style="position:absolute;right:8px;top:8px;border:none;background:none;font-size:18px;cursor:pointer">‚úï</button>
    <h3 style="margin-top:0">Rate <span class="rating-room">Room</span></h3>

    <div style="margin-bottom:0.5rem">
      <strong>Past ratings</strong>
      <div class="past-ratings" style="margin-top:0.5rem;color:#333"></div>
    </div>

    <form id="rating-form" onsubmit="submitRating(event)">
      <div style="display:flex;gap:0.5rem;margin:0.5rem 0;">
        <label><input type="radio" name="rating" value="1">1</label>
        <label><input type="radio" name="rating" value="2">2</label>
        <label><input type="radio" name="rating" value="3">3</label>
        <label><input type="radio" name="rating" value="4">4</label>
        <label><input type="radio" name="rating" value="5">5</label>
      </div>
      <div style="margin:0.5rem 0;">
        <textarea placeholder="Optional comment" style="width:100%;min-height:80px;padding:6px;border:1px solid #ddd;border-radius:6px;"></textarea>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:0.5rem;">
        <button type="button" onclick="closeRatingModal()" style="padding:8px 12px;border-radius:6px;border:1px solid #ccc;background:#fff;color:#000;cursor:pointer">Cancel</button>
        <button type="submit" style="padding:8px 12px;border-radius:6px;border:none;background:#2563eb;color:#fff;cursor:pointer">Submit rating</button>
      </div>
    </form>
  </div>
</div>

    <script>

    function renderPastRatings(container, list) {
    if (!container) return;
    if (!Array.isArray(list) || list.length === 0) {
        container.innerHTML = '<div style="color:#666">No ratings yet</div>';
        return;
    }
    container.innerHTML = list.map(r => {
        const date = new Date(r.createdAt).toLocaleString();
        const comment = r.comment ? `<div style="color:#444;margin-top:4px">${escapeHtml(r.comment)}</div>` : '';
        return `<div style="border-bottom:1px solid #eee;padding:6px 0">‚≠ê ${r.rating} <small style="color:#666;margin-left:8px">${date}</small>${comment}</div>`;
    }).join('');
    }

    function escapeHtml(s) {
    if (!s) return '';
    return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    function openRatingModal(bookingId, roomLabel) {
    const modal = document.getElementById('rating-modal');
    if (!modal) return;
    modal.querySelector('.rating-room').textContent = roomLabel || 'Room';
    modal.dataset.bookingId = bookingId || '';
    modal.classList.remove('hidden');

    const pastContainer = modal.querySelector('.past-ratings');
    if (pastContainer) {
        pastContainer.innerHTML = 'Loading‚Ä¶';
        fetch(`/api/ratings?bookingId=${encodeURIComponent(bookingId)}`)
            .then(r => {
            if (!r.ok) throw new Error('Failed to load ratings');
            return r.json();
            })
            .then(list => renderPastRatings(pastContainer, list))
            .catch(err => {
            console.error(err);
            pastContainer.innerHTML = '<div style="color:#c00">Error loading ratings</div>';
            });
    }
    }

    function closeRatingModal() {
    const modal = document.getElementById('rating-modal');
    if (!modal) return;
    modal.classList.add('hidden');
    modal.dataset.bookingId = '';
    const textarea = modal.querySelector('textarea');
    if (textarea) textarea.value = '';
    modal.querySelectorAll('input[name="rating"]').forEach(r => r.checked = false);
    }

    async function submitRating(e) {
    e.preventDefault();
    const modal = document.getElementById('rating-modal');
    const bookingId = modal.dataset.bookingId;
    const rating = modal.querySelector('input[name="rating"]:checked')?.value;
    const comment = modal.querySelector('textarea').value.trim();
    if (!rating) { alert('Please select a rating'); return; }

    try {
        const res = await fetch('/api/ratings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ bookingId: Number(bookingId), rating: Number(rating), comment })
        });
        if (!res.ok) throw new Error('Failed to submit rating');
        // refresh past ratings
        openRatingModal(bookingId, modal.querySelector('.rating-room').textContent);
    } catch (err) {
        console.error(err);
        alert('Failed to submit rating');
    }
    }

    // make functions available if other code uses them
    window.openRatingModal = openRatingModal;
    window.closeRatingModal = closeRatingModal;
    window.submitRating = submitRating;
    
    async function clearAllRatings() {
        if (!confirm('‚ö†Ô∏è This will delete ALL ratings from the database. Are you sure?')) {
            return;
        }
        
        try {
            const response = await fetch('/api/ratings/clear', {
                method: 'DELETE'
            });
            
            const result = await response.json();
            
            if (result.success) {
                alert(`‚úÖ ${result.message}\nDeleted ${result.deletedCount} ratings.`);
                // Reload the page to refresh booking history
                window.location.reload();
            } else {
                alert('‚ùå Failed to clear ratings: ' + result.error);
            }
        } catch (err) {
            console.error('Error clearing ratings:', err);
            alert('‚ùå Error clearing ratings. Check console for details.');
        }
    }
    
    window.clearAllRatings = clearAllRatings;
    </script>



    <script src="js/home.js"></script>

</body>
</html>
