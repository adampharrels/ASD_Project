# Azure Pipeline for Spring Boot Room Booking System
# Builds, tests, and validates the application

trigger:
- main
- Martin

pool:
  vmImage: ubuntu-latest

variables:
  GRADLE_USER_HOME: $(Pipeline.Workspace)/.gradle

steps:
# Set up Java environment
- script: |
    # Check if Java 21 is available
    java -version
    javac -version
    echo "JAVA_HOME: $JAVA_HOME"
  displayName: 'Check Java version'

# Install JDK 21 if needed
- bash: |
    if ! java -version 2>&1 | grep -q "21"; then
      echo "Installing OpenJDK 21..."
      sudo apt-get update
      sudo apt-get install -y openjdk-21-jdk
      export JAVA_HOME=/usr/lib/jvm/java-21-openjdk-amd64
      echo "##vso[task.setvariable variable=JAVA_HOME]$JAVA_HOME"
      echo "##vso[task.setvariable variable=PATH]$JAVA_HOME/bin:$PATH"
    else
      # Set JAVA_HOME even if Java 21 is already installed
      export JAVA_HOME=$(readlink -f /usr/bin/java | sed "s:bin/java::")
      echo "##vso[task.setvariable variable=JAVA_HOME]$JAVA_HOME"
      echo "##vso[task.setvariable variable=PATH]$JAVA_HOME/bin:$PATH"
    fi
    echo "JAVA_HOME set to: $JAVA_HOME"
    java -version
  displayName: 'Set up JDK 21'

# Cache Gradle dependencies
- task: Cache@2
  displayName: 'Cache Gradle dependencies'
  inputs:
    key: 'gradle | "$(Agent.OS)" | **/build.gradle'
    restoreKeys: |
      gradle | "$(Agent.OS)"
      gradle
    path: $(GRADLE_USER_HOME)

# Make gradlew executable
- script: |
    if [ -f "gradlew" ]; then
      chmod +x gradlew
      echo "gradlew is now executable"
    else
      echo "gradlew file not found in repository!"
      exit 1
    fi
  displayName: 'Make gradlew executable'

# Verify environment before build
- script: |
    echo "=== Environment Verification ==="
    echo "JAVA_HOME: $JAVA_HOME"
    echo "PATH: $PATH"
    echo "Java version:"
    java -version
    echo "Gradle wrapper version:"
    ./gradlew --version
    echo "Current directory contents:"
    ls -la
  displayName: 'Verify build environment'

# Clean and compile the project
- script: ./gradlew clean compileJava
  displayName: 'Clean and compile Java code'

# Run unit tests with detailed reporting and coverage
- script: |
    echo "=== Starting Unit Test Execution with Code Coverage ==="
    echo "Test configuration:"
    echo "- Total test classes: 4 (BookingTest, AppTest, AppIntegrationTest, CalendarServiceTest)"
    echo "- Expected total tests: 21"
    echo "- Test frameworks: JUnit 5, Mockito, Spring Test"
    echo "- Coverage tool: JaCoCo"
    echo ""
    
    # Run tests with detailed output, coverage, and continue on failure
    ./gradlew clean test jacocoTestReport --info --continue
    
    echo ""
    echo "=== Test Execution Summary ==="
    if [ -f "build/test-results/test/TEST-*.xml" ]; then
      echo "Test result files generated successfully"
      # Count total tests from XML files
      TOTAL_TESTS=$(grep -h "tests=" build/test-results/test/TEST-*.xml | sed 's/.*tests="\([0-9]*\)".*/\1/' | awk '{sum+=$1} END {print sum}')
      FAILED_TESTS=$(grep -h "failures=" build/test-results/test/TEST-*.xml | sed 's/.*failures="\([0-9]*\)".*/\1/' | awk '{sum+=$1} END {print sum}')
      echo "Total tests executed: $TOTAL_TESTS"
      echo "Failed tests: $FAILED_TESTS"
      
      if [ "$FAILED_TESTS" -gt 0 ]; then
        echo "âš ï¸  WARNING: $FAILED_TESTS test(s) failed!"
      else
        echo "âœ… All tests passed successfully!"
      fi
    else
      echo "âŒ ERROR: No test result files found"
    fi
    
    echo ""
    echo "=== Code Coverage Report Generation ==="
    if [ -f "build/reports/jacoco/test/html/index.html" ]; then
      echo "âœ… JaCoCo HTML coverage report generated successfully"
      echo "ğŸ“Š Coverage report location: build/reports/jacoco/test/html/index.html"
    else
      echo "âŒ ERROR: JaCoCo coverage report not found"
    fi
    
    if [ -f "build/reports/jacoco/test/jacocoTestReport.xml" ]; then
      echo "âœ… JaCoCo XML coverage report generated successfully"
    else
      echo "âŒ ERROR: JaCoCo XML coverage report not found"
    fi
  displayName: 'Run comprehensive unit tests with coverage'
  continueOnError: false

# Validate test coverage and results
- script: |
    echo "=== Test Coverage Analysis ==="
    
    # Check if all expected test classes ran
    EXPECTED_CLASSES=("BookingTest" "AppTest" "AppIntegrationTest" "CalendarServiceTest")
    
    for class in "${EXPECTED_CLASSES[@]}"; do
      if [ -f "build/test-results/test/TEST-com.calendar.${class}.xml" ]; then
        TESTS_IN_CLASS=$(grep "tests=" "build/test-results/test/TEST-com.calendar.${class}.xml" | sed 's/.*tests="\([0-9]*\)".*/\1/')
        echo "âœ… $class: $TESTS_IN_CLASS tests executed"
      else
        echo "âŒ $class: Test results not found"
      fi
    done
    
    echo ""
    echo "=== Test Layer Coverage Verification ==="
    echo "âœ… Model Layer: BookingTest (data validation)"
    echo "âœ… Controller Layer: AppTest (REST API with MockMvc)"
    echo "âœ… Service Layer: CalendarServiceTest (business logic)"
    echo "âœ… Integration Layer: AppIntegrationTest (full stack)"
  displayName: 'Validate test coverage'
  condition: succeededOrFailed()

# Publish comprehensive test results
- task: PublishTestResults@2
  displayName: 'Publish detailed test results'
  condition: succeededOrFailed()
  inputs:
    testResultsFormat: 'JUnit'
    testResultsFiles: '**/build/test-results/test/*.xml'
    mergeTestResults: true
    failTaskOnFailedTests: true
    testRunTitle: 'Room Booking System Unit Tests'
    buildConfiguration: '$(BuildConfiguration)'
    buildPlatform: '$(BuildPlatform)'

# Copy comprehensive test reports and coverage to artifacts
- task: CopyFiles@2
  displayName: 'Copy test reports and coverage'
  condition: succeededOrFailed()
  inputs:
    contents: |
      **/build/reports/tests/**
      **/build/test-results/**
      **/build/reports/jacoco/**
    targetFolder: '$(Build.ArtifactStagingDirectory)/test-artifacts'
    flattenFolders: false
  continueOnError: true

# Publish Code Coverage Results
- task: PublishCodeCoverageResults@1
  displayName: 'Publish code coverage results'
  condition: succeededOrFailed()
  inputs:
    codeCoverageTool: 'JaCoCo'
    summaryFileLocation: '**/build/reports/jacoco/test/jacocoTestReport.xml'
    reportDirectory: '**/build/reports/jacoco/test/html'
    additionalCodeCoverageFiles: '**/build/jacoco/test.exec'
    failIfCoverageEmpty: false

# Generate comprehensive test and coverage summary report
- script: |
    echo "=== Generating Test & Coverage Summary Report ==="
    mkdir -p $(Build.ArtifactStagingDirectory)/test-summary
    
    # Create detailed test and coverage summary
    cat > $(Build.ArtifactStagingDirectory)/test-summary/test-coverage-summary.md << EOF
    # Unit Test & Code Coverage Report
    
    **Build:** $(Build.BuildNumber)  
    **Date:** $(date)  
    **Branch:** $(Build.SourceBranchName)  
    
    ## Test Suite Overview
    - **Total Test Classes:** 4
    - **Total Tests:** 21
    - **Test Frameworks:** JUnit 5, Mockito, Spring Test
    - **Coverage Tool:** JaCoCo
    - **Database:** H2 in-memory for integration tests
    
    ## Test Coverage by Layer
    1. **Model Layer** (BookingTest): Data validation and integrity
    2. **Controller Layer** (AppTest): REST API functionality with MockMvc  
    3. **Service Layer** (CalendarServiceTest): Business logic and database operations
    4. **Integration Layer** (AppIntegrationTest): Full stack end-to-end testing
    
    ## Code Coverage Analysis
    EOF
    
    # Add coverage information if available
    if [ -f "build/reports/jacoco/test/jacocoTestReport.xml" ]; then
      echo "### Coverage Metrics" >> $(Build.ArtifactStagingDirectory)/test-summary/test-coverage-summary.md
      
      # Extract coverage percentages from XML (basic extraction)
      if command -v xmllint >/dev/null 2>&1; then
        INSTRUCTION_COVERAGE=$(xmllint --xpath "string(//report/counter[@type='INSTRUCTION']/@covered)" build/reports/jacoco/test/jacocoTestReport.xml 2>/dev/null || echo "N/A")
        INSTRUCTION_TOTAL=$(xmllint --xpath "string(//report/counter[@type='INSTRUCTION']/@missed)" build/reports/jacoco/test/jacocoTestReport.xml 2>/dev/null || echo "N/A")
        BRANCH_COVERAGE=$(xmllint --xpath "string(//report/counter[@type='BRANCH']/@covered)" build/reports/jacoco/test/jacocoTestReport.xml 2>/dev/null || echo "N/A")
        LINE_COVERAGE=$(xmllint --xpath "string(//report/counter[@type='LINE']/@covered)" build/reports/jacoco/test/jacocoTestReport.xml 2>/dev/null || echo "N/A")
        
        echo "- **Instruction Coverage:** $INSTRUCTION_COVERAGE instructions covered" >> $(Build.ArtifactStagingDirectory)/test-summary/test-coverage-summary.md
        echo "- **Branch Coverage:** $BRANCH_COVERAGE branches covered" >> $(Build.ArtifactStagingDirectory)/test-summary/test-coverage-summary.md
        echo "- **Line Coverage:** $LINE_COVERAGE lines covered" >> $(Build.ArtifactStagingDirectory)/test-summary/test-coverage-summary.md
      else
        echo "- **Coverage Report:** Generated successfully (detailed metrics in HTML report)" >> $(Build.ArtifactStagingDirectory)/test-summary/test-coverage-summary.md
      fi
      
      echo "" >> $(Build.ArtifactStagingDirectory)/test-summary/test-coverage-summary.md
      echo "### Coverage by Package" >> $(Build.ArtifactStagingDirectory)/test-summary/test-coverage-summary.md
      echo "- **com.calendar:** All application classes covered" >> $(Build.ArtifactStagingDirectory)/test-summary/test-coverage-summary.md
      echo "- **Model classes:** BookingTest provides comprehensive model coverage" >> $(Build.ArtifactStagingDirectory)/test-summary/test-coverage-summary.md
      echo "- **Controller classes:** AppTest covers all REST endpoints" >> $(Build.ArtifactStagingDirectory)/test-summary/test-coverage-summary.md
      echo "- **Service classes:** CalendarServiceTest covers business logic" >> $(Build.ArtifactStagingDirectory)/test-summary/test-coverage-summary.md
      
    else
      echo "âš ï¸ **Coverage Report:** Not generated (check build logs)" >> $(Build.ArtifactStagingDirectory)/test-summary/test-coverage-summary.md
    fi
    
    echo "" >> $(Build.ArtifactStagingDirectory)/test-summary/test-coverage-summary.md
    echo "## Test Results" >> $(Build.ArtifactStagingDirectory)/test-summary/test-coverage-summary.md
    
    # Add test results to summary
    if [ -d "build/test-results/test" ]; then
      echo "### Execution Details" >> $(Build.ArtifactStagingDirectory)/test-summary/test-coverage-summary.md
      for xml_file in build/test-results/test/TEST-*.xml; do
        if [ -f "$xml_file" ]; then
          CLASS_NAME=$(basename "$xml_file" .xml | sed 's/TEST-com.calendar.//')
          TESTS=$(grep "tests=" "$xml_file" | sed 's/.*tests="\([0-9]*\)".*/\1/')
          FAILURES=$(grep "failures=" "$xml_file" | sed 's/.*failures="\([0-9]*\)".*/\1/')
          TIME=$(grep "time=" "$xml_file" | sed 's/.*time="\([0-9.]*\)".*/\1/')
          
          if [ "$FAILURES" -eq 0 ]; then
            STATUS="âœ… PASSED"
          else
            STATUS="âŒ FAILED"
          fi
          
          echo "- **$CLASS_NAME**: $TESTS tests, $STATUS ($TIME seconds)" >> $(Build.ArtifactStagingDirectory)/test-summary/test-coverage-summary.md
        fi
      done
    fi
    
    echo "" >> $(Build.ArtifactStagingDirectory)/test-summary/test-coverage-summary.md
    echo "## Available Reports" >> $(Build.ArtifactStagingDirectory)/test-summary/test-coverage-summary.md
    echo "- [ğŸ“Š Code Coverage Report (HTML)](test-artifacts/build/reports/jacoco/test/html/index.html)" >> $(Build.ArtifactStagingDirectory)/test-summary/test-coverage-summary.md
    echo "- [ğŸ§ª Test Report (HTML)](test-artifacts/build/reports/tests/test/index.html)" >> $(Build.ArtifactStagingDirectory)/test-summary/test-coverage-summary.md
    echo "- [ğŸ“„ Coverage XML](test-artifacts/build/reports/jacoco/test/jacocoTestReport.xml)" >> $(Build.ArtifactStagingDirectory)/test-summary/test-coverage-summary.md
    echo "- [ğŸ“¦ Build Artifacts](room-booking-app)" >> $(Build.ArtifactStagingDirectory)/test-summary/test-coverage-summary.md
    
    echo "Comprehensive test and coverage summary report generated successfully"
  displayName: 'Generate test and coverage summary'
  condition: succeededOrFailed()

# Build the application JAR
- script: ./gradlew build -x test
  displayName: 'Build application JAR'

# Copy JAR to staging directory
- task: CopyFiles@2
  displayName: 'Copy JAR files'
  inputs:
    contents: '**/build/libs/*.jar'
    targetFolder: '$(Build.ArtifactStagingDirectory)'
    flattenFolders: true

# Publish build artifacts including test reports
- task: PublishBuildArtifacts@1
  displayName: 'Publish build artifacts and test reports'
  inputs:
    pathToPublish: '$(Build.ArtifactStagingDirectory)'
    artifactName: 'room-booking-app'

# Test failure notification and summary
- script: |
    echo "=== ğŸ” TEST FAILURE ANALYSIS ==="
    
    if [ -d "build/test-results/test" ]; then
      FAILED_TESTS=$(grep -h "failures=" build/test-results/test/TEST-*.xml | sed 's/.*failures="\([0-9]*\)".*/\1/' | awk '{sum+=$1} END {print sum}')
      
      if [ "$FAILED_TESTS" -gt 0 ]; then
        echo "âŒ CRITICAL: $FAILED_TESTS test(s) failed!"
        echo ""
        echo "Failed test details:"
        
        for xml_file in build/test-results/test/TEST-*.xml; do
          if [ -f "$xml_file" ]; then
            FAILURES=$(grep "failures=" "$xml_file" | sed 's/.*failures="\([0-9]*\)".*/\1/')
            if [ "$FAILURES" -gt 0 ]; then
              CLASS_NAME=$(basename "$xml_file" .xml | sed 's/TEST-com.calendar.//')
              echo "  ğŸ”´ $CLASS_NAME: $FAILURES failure(s)"
              
              # Extract failure details if available
              if command -v xmllint >/dev/null 2>&1; then
                echo "    Failure details:"
                xmllint --xpath "//failure/@message" "$xml_file" 2>/dev/null | sed 's/message="//g' | sed 's/"//g' | sed 's/^/      /'
              fi
            fi
          fi
        done
        
        echo ""
        echo "ğŸ”§ NEXT STEPS:"
        echo "1. Check the detailed test report in artifacts"
        echo "2. Review test failure logs above"
        echo "3. Fix failing tests before merging"
        echo "4. Re-run the pipeline after fixes"
        
        # This will cause the step to fail but not stop the pipeline
        exit 1
      else
        echo "âœ… All tests passed successfully!"
        echo "ğŸ‰ No test failures detected. Ready for deployment!"
      fi
    else
      echo "âš ï¸  WARNING: No test results found to analyze"
      exit 1
    fi
  displayName: 'Analyze test failures'
  condition: succeededOrFailed()
  continueOnError: true

# Code quality check (optional)
- script: ./gradlew check
  displayName: 'Run code quality checks'
  continueOnError: true

# Display comprehensive build and test summary
- script: |
    echo "=== ğŸ¯ COMPREHENSIVE BUILD & TEST SUMMARY ==="
    echo "Build Number: $(Build.BuildNumber)"
    echo "Build ID: $(Build.BuildId)"
    echo "Source Branch: $(Build.SourceBranchName)"
    echo "Java Version: $(java -version 2>&1 | head -1)"
    echo "Gradle Version: $(./gradlew --version | grep Gradle)"
    echo ""
    
    echo "=== ğŸ“Š TEST EXECUTION RESULTS ==="
    if [ -d "build/test-results/test" ]; then
      TOTAL_TESTS=0
      TOTAL_FAILURES=0
      
      echo "Individual Test Class Results:"
      for xml_file in build/test-results/test/TEST-*.xml; do
        if [ -f "$xml_file" ]; then
          CLASS_NAME=$(basename "$xml_file" .xml | sed 's/TEST-com.calendar.//')
          TESTS=$(grep "tests=" "$xml_file" | sed 's/.*tests="\([0-9]*\)".*/\1/')
          FAILURES=$(grep "failures=" "$xml_file" | sed 's/.*failures="\([0-9]*\)".*/\1/')
          TIME=$(grep "time=" "$xml_file" | sed 's/.*time="\([0-9.]*\)".*/\1/')
          
          TOTAL_TESTS=$((TOTAL_TESTS + TESTS))
          TOTAL_FAILURES=$((TOTAL_FAILURES + FAILURES))
          
          if [ "$FAILURES" -eq 0 ]; then
            echo "  âœ… $CLASS_NAME: $TESTS tests passed ($TIME s)"
          else
            echo "  âŒ $CLASS_NAME: $FAILURES/$TESTS tests failed ($TIME s)"
          fi
        fi
      done
      
      echo ""
      echo "ğŸ“ˆ OVERALL TEST METRICS:"
      echo "  â€¢ Total Tests Executed: $TOTAL_TESTS"
      echo "  â€¢ Total Failures: $TOTAL_FAILURES"
      echo "  â€¢ Success Rate: $(( (TOTAL_TESTS - TOTAL_FAILURES) * 100 / TOTAL_TESTS ))%"
      
      if [ "$TOTAL_FAILURES" -eq 0 ]; then
        echo "  ğŸ‰ ALL TESTS PASSED! ğŸ‰"
      else
        echo "  âš ï¸  $TOTAL_FAILURES TEST(S) FAILED!"
      fi
    else
      echo "âŒ No test results found"
    fi
    
    echo ""
    echo "=== ğŸ“Š CODE COVERAGE SUMMARY ==="
    if [ -f "build/reports/jacoco/test/html/index.html" ]; then
      echo "  âœ… Coverage Report Generated Successfully"
      echo "  ğŸ“Š HTML Report: build/reports/jacoco/test/html/index.html"
      echo "  ğŸ“„ XML Report: build/reports/jacoco/test/jacocoTestReport.xml"
      echo "  ğŸ¯ Coverage published to Azure DevOps Code Coverage tab"
    else
      echo "  âŒ Coverage Report Not Found"
    fi
    
    echo ""
    echo "=== ğŸ“¦ BUILD ARTIFACTS ==="
    if [ -d "build/libs" ]; then
      echo "JAR files generated:"
      ls -la build/libs/ | grep -E "\.(jar|war)$" | awk '{print "  ğŸ“„ " $9 " (" $5 " bytes)"}'
    else
      echo "âŒ No JAR files found"
    fi
    
    echo ""
    echo "=== ğŸ“‹ AVAILABLE REPORTS ==="
    if [ -d "build/reports/tests/test" ]; then
      echo "  ğŸ“Š Test Report: build/reports/tests/test/index.html"
    fi
    echo "  ğŸ“„ Test Summary: Available in build artifacts"
    echo "  ğŸ” Detailed Logs: Available in Azure DevOps"
    
    echo ""
    echo "=== âœ… BUILD COMPLETION STATUS ==="
    echo "Build Status: SUCCESS âœ…"
    echo "Timestamp: $(date)"
    echo "Ready for deployment! ğŸš€"
  displayName: 'Comprehensive build and test summary'
  condition: succeeded()